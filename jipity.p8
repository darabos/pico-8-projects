pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
objs={}
debug=""
function _draw()
 cls(5)
 palt(0,false)
 map()
 palt()
 sortobjs()
 foreach(objs,function(o)
  if (o.type.draw) o.type.draw(o)
 end)
 print(debug,10,10)
end

function sortkey(o)
 if fget(o.type.tile,1) then
  return o.y-8
 else
  return o.y
 end
end
function sortobjs()
 for i=1,#objs do
  local j=i
  while j>1 and sortkey(objs[j-1])>sortkey(objs[j]) do
   objs[j],objs[j-1] = objs[j-1],objs[j]
   j=j-1
  end
 end
end

t=0
function _update()
 t+=1
 foreach(objs,function(o)
  if (o.type.update) o.type.update(o)
 end)
end

function simpledraw(this)
 spr(this.type.tile,this.x,this.y)
end

function sildraw(this,s)
 sprborder(this.type.tile,this.x,this.y)
end

function sprborder(s,x,y,fx)
 for c=1,15 do pal(c,0) end
 spr(s,x+1,y,1,1,fx)
 spr(s,x-1,y,1,1,fx)
 spr(s,x,y+1,1,1,fx)
 spr(s,x,y-1,1,1,fx)
 pal()
 spr(s,x,y,1,1,fx)
end

function walkdraw(this,s)
 local s=this.type.tile
 if (this.walking) s+=t\5%2*16
 sprborder(s,this.x,this.y,t\10%2==0)
end

types={}
player={
 tile=1,
 draw=walkdraw,
 update=function(this)
  local dx=0
  local dy=0
  if (btn(⬅️)) dx-=1
  if (btn(➡️)) dx+=1
  if (btn(⬆️)) dy-=1
  if (btn(⬇️)) dy+=1
  this.move(dx,dy)
  this.walking=dx!=0 or dy!=0
 end,
}
add(types,player)

guard={
 tile=2,
 draw=walkdraw,
}
add(types,guard)

miss={
 tile=3,
 draw=walkdraw,
}
add(types,miss)

coin={
 tile=6,
 draw=sildraw,
}
add(types,coin)

flower={
 tile=7,
 draw=sildraw,
}
add(types,flower)

function _init()
 for x=0,16 do
  for y=0,16 do
   local t=mget(x,y)
   foreach(types,function(ty)
    if ty.tile==t then
     local o={type=ty,x=x*8,y=y*8}
     if (ty.init!=nil) ty.init(o)
     initobj(o)
     add(objs,o)
     mset(x,y,0)
    end
   end)
  end
 end
end

function initobj(o)
 o.rx=0
 o.ry=0
 o.w=8
 o.h=8
 o.is_solid=function(x,y)
  local ox=o.x+x
  local oy=o.y+y
  for i=0,1 do for j=0,1 do
   local t=mget(ox\8+i,oy\8+j)
   if (fget(t,0)) return true
  end end
  for i=1,#objs do
   local e=objs[i]
   if not (
    o==e or
    not fget(e.type.tile,0) or
    ox+o.w<=e.x or
    ox>=e.x+e.w or
    oy+o.h<=e.y or
    oy>=e.y+e.h) then
    return true
   end
  end
  return false
 end
 o.move=function(x,y)
	 if (x==0 and y==0) return
  o.rx+=x
  o.ry+=y
  x=flr(o.rx)
  y=flr(o.ry)
  o.rx-=x
  o.ry-=y
  local sx=sign(x)
  for i=1,abs(x) do
   if o.is_solid(sx,0) then
    break
   else
    o.x+=sx
   end
  end
  local sy=sign(y)
  for i=1,abs(y) do
   if o.is_solid(0,sy) then
    break
   else
    o.y+=sy
   end
  end
 end
end

function sign(x)
 if (x>0) return 1
 if (x<0) return -1
 return 0
end
__gfx__
000000000044440000cccc0009999990555555552ff2ff0200000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00dddddd09aaaaaa9155515552222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000a4aa4a00d0dd0d09acaaca955555555f2ff2ff2000aa000000000000000000000000000000000000000000000000000000000000000000000000000
000770009aaaaaa96dddddd60aaaaaa0555155552220022200a99a00000700000000000000000000000000000000000000000000000000000000000000000000
00077000099999900666666000eeee0055515555ff2ff2ff00999900007970000000000000000000000000000000000000000000000000000000000000000000
007007000999999006666660aeeeeeea555155552202220200999900000700000000000000000000000000000000000000000000000000000000000000000000
000000000044440000cccc000eeeeee0555555512ff2ff2f00499400000b30000000000000000000000000000000000000000000000000000000000000000000
00000000009009000060060000c00c00551555512222222200044000000b00000000000000000000000000000000000000000000000000000000000000000000
00000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000a4aa4a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009aaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010100010200000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000004000505050505000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000040000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000004000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000010000040000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000070004040400000003000600060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
